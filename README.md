# TS HELP AD

Помощник для службы техподдержки с графическим интерфейсом (Tkinter) для работы с учётными записями и мониторингом звонков FreePBX.
Основной исполняемый файл — `TS HELPER V4.1.py`; предыдущая версия сохранена в репозитории как архивный вариант.

## Возможности
- Управление списком пользователей (добавление, редактирование, импорт/экспорт).
- Синхронизация с Active Directory и проверка доступности хостов.
- Синхронизация с GLPI для подбора префиксов ПК и выбор основного устройства при наличии нескольких вариантов.
- Запуск SSH/административных команд с учётом сохранённых настроек.
- Мониторинг звонков (Call Watcher) с парсингом страниц FreePBX.
- Логирование действий в `app.log` и сохранение отладочных дампов PBX в каталоге `_pbx_debug`.
- Сворачивание приложения в системный трей или прозрачный мини-виджет поверх всех окон.

## Требования
- Python 3.9+ (разработка ориентирована на Windows, хранение паролей завязано на Windows-хранилища).
- Виртуальная среда (рекомендуется) и зависимости из `requirements.txt`.
- Наличие `tkinter` в установленной сборке Python.
- Для функций шифрования DPAPI и интеграции с AD требуется Windows.
- Для безопасного хранения паролей используется библиотека `keyring` и доступное в системе защищённое хранилище учётных данных (Windows Credential Manager). При отсутствии `keyring` используется резервное DPAPI-хранилище в файле `.ts_help_ad_secrets.json` рядом с конфигурацией.

## Установка и запуск
```bash
python -m venv .venv
source .venv/bin/activate  # или .venv\\Scripts\\activate в Windows
pip install -r requirements.txt
python "TS HELPER V4.1.py"
```

## Настройка
Основные параметры задаются в `config.json`:
- `ad_username` — учётные данные для подключения к AD (пароль хранится в keyring по ссылке из конфигурации).
- `cw_url`, `cw_cookie`, `cw_exts` — доступ к странице статистики FreePBX и отслеживаемые внутренние номера.
- `cw_login` — учётные данные FreePBX (пароль хранится в keyring).
- `ssh_login`, `ssh_terminal` — запуск удалённых сессий (пароль хранится в keyring).
- `glpi_api_url`, `glpi_app_token`, `glpi_user_token`, `glpi_prefix_field` — доступ к GLPI API (apirest.php) для получения закреплённых ПК и префиксов. Токены сохраняются в защищённом хранилище. Поле `glpi_prefix_field` задаёт имя поля в ответе GLPI, откуда брать префикс/тип ОС (например, `name` или пользовательское поле). В списке устройств игнорируются хосты с префиксами `wr-` и `lr-`.
- `glpi_verify_ssl` — проверять SSL-сертификат при обращении к GLPI. Для самоподписанных сертификатов снимите галочку в настройках или укажите путь к доверенному сертификату через системное хранилище.
- `glpi_use_in_ad_sync` — использовать ли сверку с GLPI при синхронизации AD. Отключение помогает временно пропускать обращения к GLPI, если там есть проблемы с сертификатами или доступностью.
- Геометрия окон (`window_geometry` и др.) сохраняется автоматически при закрытии.

Пароли (`ad_password`, `ssh_password`, `cw_password`, `reset_password`) сохраняются только в защищённом хранилище: в Windows Credential Manager через `keyring` либо в резервном DPAPI-файле рядом с конфигурацией. В `config.json` остаются только идентификаторы записей. При недоступности защищённого хранилища пароли не отображаются в настройках, выводится предупреждение и значения сохраняются лишь временно в памяти.

Список отображаемых пользователей хранится в `users.json`.

## Известные особенности
- Обновления с GitHub проверяются в фоне; при отсутствии `requests` проверка пропускается.
- Логика DPAPI (`pywin32`) работает только в Windows; на других ОС защищённое хранилище может быть недоступно, поэтому пароли не сохраняются и не отображаются.
- При использовании Call Watcher убедитесь, что cookie FreePBX актуальна, иначе парсинг будет отображать страницу входа.
- Логи фиксируют источник выбранного префикса (AD/GLPI), а также заменённые логины и переключения основного ПК.
